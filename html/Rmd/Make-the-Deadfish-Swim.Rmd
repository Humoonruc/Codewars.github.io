---
title: "Make the Deadfish Swim"
author: "Humoon"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include = FALSE}
source("./config/config.R")

## global options ===================================
knitr::opts_chunk$set(
  width = config$width,
  fig.width = config$fig.width,
  fig.asp = config$fig.asp,
  out.width = config$out.width,
  fig.align = config$fig.align,
  fig.path = config$fig.path,
  fig.show = config$fig.show,
  warn = config$warn,
  warning = config$warning,
  message = config$message,
  echo = config$echo,
  eval = config$eval,
  tidy = config$tidy,
  comment = config$comment,
  collapse = config$collapse,
  cache = config$cache,
  cache.comments = config$cache.comments,
  autodep = config$autodep
)
```



### Solution

#### R
```{r}
library(tidyverse)
library(magrittr)


# 写成返回两个值的函数，避免定义全局变量arr
# obj 包含两个分量：整数 n 和数组 arr
dict <- list(
  "i" = \(obj) list(n = obj$n + 1, arr = obj$arr),
  "d" = \(obj) list(n = obj$n - 1, arr = obj$arr),
  "s" = \(obj) list(n = obj$n^2, arr = obj$arr),
  "o" = \(obj) list(n = obj$n, arr = c(obj$arr, obj$n))
)


deadfish <- function(commands) {
  valid_commands <- commands %>%
    str_split("") %>%
    unlist() %>%
    keep(~ .x %in% c("i", "d", "s", "o"))

  # 此处不用 reduce 用 for 循环会更加清楚
  obj <- list(n = 0, arr = integer(0))
  for (char in valid_commands) {
    obj <- dict[[char]](obj)
  }
  obj$arr
}


library(testthat)
test_that("Unit Test", {
  expect_equal(deadfish("iiisxxxdoso"), c(8, 64))
})
```


#### Julia
```{julia}


# 写成返回两个值的函数，避免定义全局变量arr
# 更彻底地解耦，使程序易于维护
dict = Dict(
  'i' => (x, arr) -> (x + 1, arr),
  'd' => (x, arr) -> (x - 1, arr),
  's' => (x, arr) -> (x^2, arr),
  'o' => (x, arr) -> (x, push!(arr, x))
)


function deadfish(data)
  valid_commands = filter(c -> c ∈ "idso", data)
  x, output = 0, [] # 初始值
  for c in valid_commands
    x, output = dict[c](x, output) # 串行操作
  end
  return output
end


using Test
@test deadfish("iiisxxxdoso") == [8, 64]
```


#### JavaScript

```{node}


const dict = new Map()
  .set('i', ({ n: k, output: arr }) => ({ n: k + 1, output: arr }))
  .set('d', ({ n: k, output: arr }) => ({ n: k - 1, output: arr }))
  .set('s', ({ n: k, output: arr }) => ({ n: k ** 2, output: arr }))
  .set('o', ({ n: k, output: arr }) => ({ n: k, output: arr.concat(k) }));


function parse(data) {
  let result = data.split("")
    .filter(c => "idso".includes(c))
    .reduce(
      callBack = (obj, c) => dict.get(c)(obj),
      initialValue = { n: 0, output: [] }
    );

  return result.output;
}


console.log(parse("iiisxxxdoso")); // [8, 64]
```


